#!/usr/bin/env bash

usage() {
  echo "Usage: $0" >&2
  exit 1 # Exit with an error status
}

# Command requires a single argument
if [[ "$1" == "help" || "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

COSMIC_FILE_LOCATION="$HOME/.config/cosmic/com.system76.CosmicComp/v1/xkb_config"

# For Pop OS COSMIC-based
function toggle_cosmic() {
  NOT_SWAPPED="options: Some(\""
  SWAPPED="options: Some(\"altwin:swap_alt_win,"

  # TODO: make this more modular, this is currently a hack
  # Feature request: https://github.com/pop-os/cosmic-epoch/issues/527
  if cat $COSMIC_FILE_LOCATION | grep -q "${SWAPPED}"; then
    sed -i '/^    options: Some("/c\    options: Some("caps:ctrl_modifier,compose:ralt"),' $COSMIC_FILE_LOCATION
    echo "Alt and Win keys are back to normal"
  else
    sed -i '/^    options: Some("/c\    options: Some("altwin:swap_alt_win,caps:ctrl_modifier,compose:ralt"),' $COSMIC_FILE_LOCATION
    echo "Swapped Alt and Win keys"
  fi
}

# For gnome-based
function toggle_gnome() {
  SCHEMA="org.gnome.desktop.input-sources"
  KEY="xkb-options"

  CURRENT_OPTIONS=$(gsettings get "$SCHEMA" "$KEY")
  TARGET_VALUE="altwin:swap_alt_win"

  if [[ "$CURRENT_OPTIONS" == *"$TARGET_VALUE"* ]]; then
    NEW_OPTIONS=$(echo "$CURRENT_OPTIONS" \
      | sed -E "s/(, )?'$TARGET_VALUE'(, )?/\1/" \
      | sed -E "s/\[ *,/\[/" \
      | sed -E "s/, *\]/\]/")
    gsettings set "$SCHEMA" "$KEY" "$NEW_OPTIONS"
    echo "Alt and Win keys are back to normal"
  else
    if [[ "$CURRENT_OPTIONS" == "[]" ]]; then
      NEW_OPTIONS="['${TARGET_VALUE}']"
    else
      NEW_OPTIONS=$(echo "$CURRENT_OPTIONS" | sed "s/\]/, '${TARGET_VALUE}']/")
    fi
    gsettings set "$SCHEMA" "$KEY" "$NEW_OPTIONS"
    echo "Swapped Alt and Win keys"
  fi
}

if [[ -f $COSMIC_FILE_LOCATION ]]; then
  toggle_cosmic
else
  toggle_gnome
fi


